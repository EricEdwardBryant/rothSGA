---
title: "Batch report"
author: "{{{ author }}}"
date: "{{{ date }}}"
output: html_document
params:
  re_annotate: FALSE
  re_calibrate: FALSE
  re_measure: FALSE
  needs_review: TRUE  # Change me to FALSE after manual review
---

## Setup

```{r}
library(rothSGA)
dir = '{{{ data_dir }}}'
```

## Annotate Images

```{r}
screenmill::annotate(dir, overwrite = params$re_annotate)
add_biological_replicates(dir, file = 'biological-replicate-annotation.csv')
```

## Calibrate, measure, and review colonies

```{r}
screenmill::calibrate(dir, overwrite = params$re_calibrate)
screenmill::measure(dir, overwrite = params$re_measure)
if (params$needs_review) screenmill::review(dir)
```

## Apply normalizations

```{r}
data_all <-
  screenmill::read_screenmill(dir) %>%
  left_join(read_csv(file.path(dir, 'biological-replicate-annotation.csv'))) %>%
  normalize_spatial_effect(of = 'size', death_thresh = 0.25, prefix = 'size_') %>%
  normalize_plate_effect(of = 'size_spatial_norm', prefix = 'size_spatial_') %>%
  plot_sm_data(path = )

data_bio_reps <-
  group_by(plate_id, row, column) %>%
  summarise(
    n                = n(),            # exclusions have already been removed
    mean_size_norm   = mean(size_spatial_plate_norm),
    median_size_norm = median(size_spatial_plate_norm),
    sd_size_norm     = sd(size_spatial_plate_norm)
  ) %>%
  ungroup() 
```

## Quality control

```{r}
check_self_crosses(dir)
check_dead_strains(dir)
check_query_sensitivity_to_drug(dir)
plot_sm_data(dir)
```
